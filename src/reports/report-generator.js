/**
 * Report Generator for Frontend Auditor Agent
 * Generates reports in various formats (JSON, Markdown, HTML)
 */

import { writeFile } from 'fs/promises';
import { SEVERITY_LEVELS } from '../config/mcp-config.js';

export class ReportGenerator {
  constructor() {
    this.reportTemplates = {
      markdown: this.generateMarkdown.bind(this),
      json: this.generateJSON.bind(this),
      html: this.generateHTML.bind(this)
    };
  }

  /**
   * Generate JSON report
   */
  generateJSON(auditReport) {
    return JSON.stringify(auditReport, null, 2);
  }

  /**
   * Generate Markdown report
   */
  generateMarkdown(auditReport) {
    const { repository, summary, categories, timestamp } = auditReport;
    
    let markdown = `# Frontend Audit Report\n\n`;
    markdown += `**Repository:** ${repository.owner}/${repository.repo}\n`;
    markdown += `**Generated:** ${new Date(timestamp).toLocaleString()}\n\n`;

    // Summary section
    markdown += `## Summary\n\n`;
    markdown += `| Metric | Value |\n`;
    markdown += `|--------|-------|\n`;
    markdown += `| Total Issues | ${summary.totalIssues} |\n`;
    markdown += `| Critical Issues | ${summary.criticalIssues} |\n`;
    markdown += `| High Issues | ${summary.highIssues} |\n`;
    markdown += `| Medium Issues | ${summary.mediumIssues} |\n`;
    markdown += `| Low Issues | ${summary.lowIssues} |\n`;
    markdown += `| Compliance Score | ${summary.complianceScore}% |\n\n`;

    // Compliance badge
    const badgeColor = this.getComplianceBadgeColor(summary.complianceScore);
    markdown += `![Compliance Score](https://img.shields.io/badge/Compliance-${summary.complianceScore}%25-${badgeColor})\n\n`;

    // Category breakdown
    markdown += `## Category Breakdown\n\n`;
    
    for (const [categoryName, categoryData] of Object.entries(categories)) {
      if (categoryData.issues.length === 0) continue;

      markdown += `### ${categoryName} (Score: ${categoryData.score}%)\n\n`;
      
      categoryData.issues.forEach(issue => {
        const severityEmoji = this.getSeverityEmoji(issue.severity);
        markdown += `${severityEmoji} **${issue.severity.toUpperCase()}** - ${issue.message}\n`;
        markdown += `- **File:** \`${issue.file || 'N/A'}\`\n`;
        markdown += `- **Description:** ${issue.description || 'No description provided'}\n`;
        if (issue.suggestion) {
          markdown += `- **Suggestion:** ${issue.suggestion}\n`;
        }
        markdown += `\n`;
      });
    }

    // Recommendations section
    if (auditReport.recommendations && auditReport.recommendations.length > 0) {
      markdown += `## Recommendations\n\n`;
      auditReport.recommendations.forEach((rec, index) => {
        markdown += `${index + 1}. ${rec}\n`;
      });
      markdown += `\n`;
    }

    // Quick fixes section
    markdown += `## Quick Fixes\n\n`;
    markdown += `### High Priority\n\n`;
    
    const criticalAndHighIssues = this.getCriticalAndHighIssues(categories);
    if (criticalAndHighIssues.length > 0) {
      criticalAndHighIssues.forEach((issue, index) => {
        markdown += `${index + 1}. **${issue.message}** (\`${issue.file}\`)\n`;
        if (issue.suggestion) {
          markdown += `   - ${issue.suggestion}\n`;
        }
      });
    } else {
      markdown += `No critical or high priority issues found! ðŸŽ‰\n`;
    }

    markdown += `\n### Generated by Frontend Auditor Agent\n`;
    markdown += `This report was automatically generated to help maintain DTSL frontend standards.\n`;

    return markdown;
  }

  /**
   * Generate HTML report
   */
  generateHTML(auditReport) {
    const markdownContent = this.generateMarkdown(auditReport);
    
    return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Audit Report - ${auditReport.repository.owner}/${auditReport.repository.repo}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .issue-card {
            border-left: 4px solid #e9ecef;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .critical { border-left-color: #dc3545; }
        .high { border-left-color: #fd7e14; }
        .medium { border-left-color: #ffc107; }
        .low { border-left-color: #6c757d; }
        .score-good { color: #28a745; }
        .score-warning { color: #ffc107; }
        .score-danger { color: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="markdown-content">
        ${this.markdownToHTML(markdownContent)}
    </div>
</body>
</html>`;
  }

  /**
   * Save report to file
   */
  async saveReport(content, filePath) {
    try {
      await writeFile(filePath, content, 'utf8');
      return true;
    } catch (error) {
      console.error('Error saving report:', error.message);
      throw error;
    }
  }

  /**
   * Get compliance badge color
   */
  getComplianceBadgeColor(score) {
    if (score >= 90) return 'brightgreen';
    if (score >= 70) return 'yellow';
    if (score >= 50) return 'orange';
    return 'red';
  }

  /**
   * Get severity emoji
   */
  getSeverityEmoji(severity) {
    switch (severity) {
      case SEVERITY_LEVELS.CRITICAL: return 'ðŸš¨';
      case SEVERITY_LEVELS.HIGH: return 'âš ï¸';
      case SEVERITY_LEVELS.MEDIUM: return 'ðŸ“‹';
      case SEVERITY_LEVELS.LOW: return 'ðŸ’¡';
      default: return 'â„¹ï¸';
    }
  }

  /**
   * Get critical and high issues for quick fixes section
   */
  getCriticalAndHighIssues(categories) {
    const criticalAndHighIssues = [];
    
    for (const categoryData of Object.values(categories)) {
      const filteredIssues = categoryData.issues.filter(issue =>
        issue.severity === SEVERITY_LEVELS.CRITICAL || issue.severity === SEVERITY_LEVELS.HIGH
      );
      criticalAndHighIssues.push(...filteredIssues);
    }
    
    return criticalAndHighIssues;
  }

  /**
   * Simple markdown to HTML converter (basic implementation)
   */
  markdownToHTML(markdown) {
    return markdown
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/gim, '<em>$1</em>')
      .replace(/`(.*?)`/gim, '<code>$1</code>')
      .replace(/\n\n/gim, '</p><p>')
      .replace(/\n/gim, '<br>')
      .replace(/^(.+)$/gim, '<p>$1</p>');
  }

  /**
   * Generate executive summary for stakeholders
   */
  generateExecutiveSummary(auditReport) {
    const { repository, summary } = auditReport;
    
    let executiveSummary = `# Executive Summary - ${repository.owner}/${repository.repo}\n\n`;
    
    // Overall assessment
    if (summary.complianceScore >= 90) {
      executiveSummary += `âœ… **Excellent compliance** - The repository meets DTSL standards with a score of ${summary.complianceScore}%.\n\n`;
    } else if (summary.complianceScore >= 70) {
      executiveSummary += `âš ï¸ **Good compliance** - The repository largely meets DTSL standards with a score of ${summary.complianceScore}%. Minor improvements needed.\n\n`;
    } else if (summary.complianceScore >= 50) {
      executiveSummary += `ðŸ”§ **Moderate compliance** - The repository meets some DTSL standards with a score of ${summary.complianceScore}%. Several improvements needed.\n\n`;
    } else {
      executiveSummary += `ðŸš¨ **Low compliance** - The repository requires significant work to meet DTSL standards. Current score: ${summary.complianceScore}%.\n\n`;
    }

    // Key metrics
    executiveSummary += `## Key Metrics\n\n`;
    executiveSummary += `- **Critical Issues:** ${summary.criticalIssues} (require immediate attention)\n`;
    executiveSummary += `- **High Priority Issues:** ${summary.highIssues} (should be addressed soon)\n`;
    executiveSummary += `- **Total Issues:** ${summary.totalIssues}\n\n`;

    // Action items
    if (summary.criticalIssues > 0 || summary.highIssues > 0) {
      executiveSummary += `## Immediate Action Required\n\n`;
      executiveSummary += `This repository has ${summary.criticalIssues + summary.highIssues} high-priority issues that should be addressed to ensure compliance with DTSL frontend standards.\n\n`;
    }

    return executiveSummary;
  }
}